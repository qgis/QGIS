# QGIS Dockeræ„å»ºå®Œæ•´æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»QGISé¡¹ç›®çš„Dockeræ„å»ºæ–¹æ¡ˆï¼ŒåŒ…æ‹¬å®˜æ–¹æ„å»ºç³»ç»Ÿå’Œä¼˜åŒ–æ–¹æ¡ˆã€‚

## ç›®å½•
- [æ¦‚è¿°](#æ¦‚è¿°)
- [QGISå®˜æ–¹Dockeræ„å»ºä½“ç³»](#qgiså®˜æ–¹dockeræ„å»ºä½“ç³»)
- [æ„å»ºæ–¹æ¡ˆå¯¹æ¯”](#æ„å»ºæ–¹æ¡ˆå¯¹æ¯”)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é—®é¢˜æ’æŸ¥](#é—®é¢˜æ’æŸ¥)
- [è„šæœ¬è¯´æ˜](#è„šæœ¬è¯´æ˜)

## æ¦‚è¿°

QGISæä¾›äº†å®Œæ•´çš„Dockeræ„å»ºä½“ç³»ï¼Œç”¨äºï¼š
- æŒç»­é›†æˆå’Œè‡ªåŠ¨åŒ–æµ‹è¯•
- æ ‡å‡†åŒ–çš„æ„å»ºç¯å¢ƒ
- è·¨å¹³å°æ„å»ºæ”¯æŒ
- å¼€å‘ç¯å¢ƒéš”ç¦»

### é¡¹ç›®ä¸­çš„Dockeræ–‡ä»¶ç»“æ„
```
.docker/
â”œâ”€â”€ qgis3-qt5-build-deps.dockerfile  # Qt5ä¾èµ–é•œåƒ
â”œâ”€â”€ qgis3-qt6-build-deps.dockerfile  # Qt6ä¾èµ–é•œåƒ  
â”œâ”€â”€ qgis.dockerfile                  # ä¸»æ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-qgis-build.sh            # å®˜æ–¹æ„å»ºè„šæœ¬
â”œâ”€â”€ docker-qgis-test.sh             # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ docker-compose-*.yml            # æµ‹è¯•ç¯å¢ƒç¼–æ’
â””â”€â”€ qgis_resources/                  # æµ‹è¯•èµ„æº
```

## QGISå®˜æ–¹Dockeræ„å»ºä½“ç³»

### 1. å¤šé˜¶æ®µæ„å»ºæ¶æ„

```mermaid
graph TD
    A[ubuntu:24.04] --> B[binary-for-oracle]
    B --> C[binary-only] 
    C --> D[qgis3-build-deps]
    D --> E[QGISä¸»ç¨‹åºæ„å»º]
    E --> F[æœ€ç»ˆQGISé•œåƒ]
```

### 2. æ ¸å¿ƒç»„ä»¶

#### ä¾èµ–é•œåƒ (qgis3-build-deps)
- **åŸºç¡€ç³»ç»Ÿ**: Ubuntu 24.04
- **æ„å»ºå·¥å…·**: clang, cmake, ninja, ccache
- **Qtæ¡†æ¶**: Qt5å®Œæ•´å¼€å‘å¥—ä»¶
- **åœ°ç†ç©ºé—´åº“**: GDAL, GEOS, PROJ, SpatiaLite
- **Pythonç¯å¢ƒ**: Python3 + PyQt5å®Œæ•´ç»‘å®š
- **æ•°æ®åº“æ”¯æŒ**: PostgreSQL, Oracle, MSSQL, HANA

#### ä¸»æ„å»ºæ–‡ä»¶ (qgis.dockerfile)
```dockerfile
FROM qgis/qgis3-build-deps:latest AS BUILDER
# ä½¿ç”¨å®˜æ–¹ä¾èµ–é•œåƒ
COPY . /QGIS                    # å¤åˆ¶æºç 
RUN cmake -GNinja ...           # é…ç½®æ„å»º
RUN ninja install               # ç¼–è¯‘å®‰è£…
```

### 3. æ„å»ºé…ç½®ç‰¹ç‚¹

- **ç¼–è¯‘å™¨**: Clang + ccacheåŠ é€Ÿ
- **æ„å»ºç³»ç»Ÿ**: Ninja (æ¯”makeæ›´å¿«)
- **å®Œæ•´åŠŸèƒ½**: Desktop + Server + 3D + Pythonç»‘å®š
- **æµ‹è¯•æ”¯æŒ**: å®Œæ•´çš„æµ‹è¯•æ¡†æ¶é›†æˆ
- **å¤šæ•°æ®åº“**: Oracle, MSSQL, PostgreSQL, HANAæ”¯æŒ

## æ„å»ºæ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ„å»ºæ—¶é—´ | Pythonæ”¯æŒ | å®Œæ•´åŠŸèƒ½ | ç½‘ç»œä¾èµ– | æ¨èåº¦ |
|------|----------|------------|----------|----------|--------|
| å®˜æ–¹Docker | 60åˆ†é’Ÿ(é¦–æ¬¡)/20åˆ†é’Ÿ(åç»­) | âœ… å®Œæ•´ | âœ… å®Œæ•´ | ğŸŒ ä¸­ç­‰ | â­â­â­â­â­ |
| ç®€åŒ–Docker | 25åˆ†é’Ÿ | âŒ æ—  | âš ï¸ åŸºç¡€ | ğŸŒ ä¸­ç­‰ | â­â­â­â­ |
| æœ¬åœ°æ„å»º | 30åˆ†é’Ÿ | âŒ æ—  | âš ï¸ åŸºç¡€ | âŒ æ—  | â­â­â­ |
| é¢„ç¼–è¯‘ä¸‹è½½ | 5åˆ†é’Ÿ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | ğŸŒ é«˜ | â­â­â­ |
| ä¼ ç»Ÿæ„å»º | 2å°æ—¶+ | âœ… å®Œæ•´ | âœ… å®Œæ•´ | âŒ æ—  | â­â­ |

## å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶
```bash
# å®‰è£…Docker
sudo apt update && sudo apt install docker.io
sudo systemctl start docker
sudo usermod -aG docker $USER  # é‡æ–°ç™»å½•ç”Ÿæ•ˆ
```

### æ–¹æ¡ˆ1: å®˜æ–¹Dockeræ„å»ºï¼ˆæ¨èï¼‰

```bash
# ä½¿ç”¨å®˜æ–¹æ„å»ºç³»ç»Ÿ
./scripts/build_official_docker.sh
```

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨QGISå›¢é˜ŸåŒæ ·çš„æ„å»ºæµç¨‹
- âœ… å®Œæ•´åŠŸèƒ½æ”¯æŒï¼ˆPythonã€3Dã€æ‰€æœ‰æ•°æ®åº“ï¼‰
- âœ… ç»è¿‡å……åˆ†æµ‹è¯•å’Œä¼˜åŒ–
- â±ï¸ é¦–æ¬¡æ„å»º60åˆ†é’Ÿï¼Œåç»­20åˆ†é’Ÿ

### æ–¹æ¡ˆ2: ç®€åŒ–Dockeræ„å»º

```bash
# å¿«é€Ÿæ„å»ºï¼ˆæ— Pythonç»‘å®šï¼‰
./scripts/build_with_docker.sh
```

**ç‰¹ç‚¹**:
- âœ… æ ¸å¿ƒGISåŠŸèƒ½å®Œæ•´
- âŒ æ— Pythonæ’ä»¶å’Œè„šæœ¬æ”¯æŒ  
- â±ï¸ 25åˆ†é’Ÿå®Œæˆ

### æ–¹æ¡ˆ3: æœ¬åœ°æ„å»º

```bash
# æ— Dockerä¾èµ–çš„æœ¬åœ°æ„å»º
./scripts/build_local_fast.sh
```

**ç‰¹ç‚¹**:
- âœ… æ— ç½‘ç»œä¾èµ–
- âœ… ç³»ç»Ÿé›†æˆåº¦é«˜
- âŒ ç¯å¢ƒä¸éš”ç¦»
- â±ï¸ 30åˆ†é’Ÿå®Œæˆ

## é—®é¢˜æ’æŸ¥

### Dockerç½‘ç»œé—®é¢˜

#### ç—‡çŠ¶
```
Get \"https://registry-1.docker.io/v2/\": dial tcp: i/o timeout
```

#### è§£å†³æ–¹æ¡ˆ
```bash
# é…ç½®å›½å†…é•œåƒæº
./scripts/setup_docker_mirror.sh

# æˆ–æ‰‹åŠ¨ä¸‹è½½é•œåƒ
./scripts/download_docker_images.sh
```

### æ„å»ºç¼“æ…¢é—®é¢˜

#### SIP Pythonç»‘å®šç”Ÿæˆæ…¢
```bash
# ç—‡çŠ¶ï¼šå¡åœ¨sip-buildæ­¥éª¤
/usr/bin/python3 /usr/bin/sip-build --no-protected-is-public...
```

#### è§£å†³æ–¹æ¡ˆ
1. **ä½¿ç”¨å®˜æ–¹Docker** - å·²ä¼˜åŒ–æ­¤é—®é¢˜
2. **è·³è¿‡Pythonç»‘å®š** - ä½¿ç”¨ç®€åŒ–æ„å»º
3. **å¢åŠ å†…å­˜** - ç¡®ä¿è‡³å°‘8GBå¯ç”¨å†…å­˜

### ç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æ£€æŸ¥ç©ºé—´
df -h

# æ¸…ç†Docker
docker system prune -a

# ä½¿ç”¨å¤–éƒ¨å­˜å‚¨
export DOCKER_TMPDIR=/path/to/large/disk
```

## è„šæœ¬è¯´æ˜

### å®˜æ–¹æ„å»ºè„šæœ¬

#### `build_official_docker.sh`
- åŸºäºQGISå®˜æ–¹æ„å»ºç³»ç»Ÿ
- å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
- å®Œæ•´åŠŸèƒ½æ”¯æŒ

#### `setup_docker_mirror.sh`  
- é…ç½®Dockerå›½å†…é•œåƒæº
- è§£å†³ç½‘ç»œè¿æ¥é—®é¢˜

### ç®€åŒ–æ„å»ºè„šæœ¬

#### `build_with_docker.sh`
- å¿«é€ŸDockeræ„å»º
- ç¦ç”¨Pythonç»‘å®š
- é€‚åˆåŠŸèƒ½æµ‹è¯•

#### `build_local_fast.sh`
- æœ¬åœ°ç¯å¢ƒæ„å»º  
- æ— Dockerä¾èµ–
- ä½¿ç”¨ç³»ç»Ÿåº“

### ä¸‹è½½è„šæœ¬

#### `download_qgis_packages.sh`
- ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘åŒ…
- æ”¯æŒUbuntu/Debian
- æœ€å¿«è·å¾—QGIS

#### `download_docker_images.sh`
- æ‰‹åŠ¨ä¸‹è½½Dockeré•œåƒ
- ä½¿ç”¨å›½å†…é•œåƒæº
- è§£å†³ç½‘ç»œé—®é¢˜

## Dockeræ„å»ºè¯¦ç»†æµç¨‹

### å®˜æ–¹æ„å»ºæ­¥éª¤

1. **æ„å»ºä¾èµ–é•œåƒ**
```bash
docker build -f .docker/qgis3-qt5-build-deps.dockerfile -t qgis3-build-deps .docker/
```

2. **æ„å»ºä¸»ç¨‹åº**
```bash  
docker build -f .docker/qgis.dockerfile -t qgis-local .
```

3. **å¯¼å‡ºç»“æœ**
```bash
docker cp container_id:/usr/ output/
dpkg-deb --build output/ qgis-official.deb
```

### æ„å»ºä¼˜åŒ–é…ç½®

#### CMakeé…ç½®
```cmake
cmake -GNinja \
  -DCMAKE_BUILD_TYPE=Release \
  -DWITH_DESKTOP=ON \
  -DWITH_SERVER=ON \
  -DWITH_3D=ON \
  -DWITH_BINDINGS=ON \
  -DENABLE_TESTS=OFF \
  -DUSE_CCACHE=ON
```

#### ç¼–è¯‘ä¼˜åŒ–
- **Ninjaæ„å»ºç³»ç»Ÿ**: æ¯”makeå¿«30%
- **ccacheç¼“å­˜**: é‡å¤æ„å»ºåŠ é€Ÿ
- **å¹¶è¡Œç¼–è¯‘**: ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
- **é“¾æ¥å™¨ä¼˜åŒ–**: ä½¿ç”¨moldé“¾æ¥å™¨

## æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒæ¨è

1. **æ—¥å¸¸å¼€å‘**: ä½¿ç”¨å®˜æ–¹Dockeræ„å»º
2. **åŠŸèƒ½æµ‹è¯•**: ä½¿ç”¨ç®€åŒ–Dockeræ„å»º  
3. **å¿«é€ŸéªŒè¯**: ä½¿ç”¨é¢„ç¼–è¯‘åŒ…ä¸‹è½½
4. **ç¦»çº¿ç¯å¢ƒ**: ä½¿ç”¨æœ¬åœ°æ„å»º

### æ€§èƒ½ä¼˜åŒ–

1. **å¢åŠ å†…å­˜**: è‡³å°‘8GBï¼Œæ¨è16GB
2. **SSDå­˜å‚¨**: æ˜¾è‘—æå‡æ„å»ºé€Ÿåº¦
3. **ç½‘ç»œä¼˜åŒ–**: é…ç½®é•œåƒæº
4. **ç¼“å­˜åˆ©ç”¨**: ä¿ç•™Dockerå±‚ç¼“å­˜

### æ•…éšœæ’é™¤

1. **æ—¥å¿—æŸ¥çœ‹**:
```bash
docker logs container_id
```

2. **äº¤äº’è°ƒè¯•**:
```bash  
docker run -it qgis3-build-deps /bin/bash
```

3. **èµ„æºç›‘æ§**:
```bash
docker stats
htop
```

## æ€»ç»“

QGISçš„Dockeræ„å»ºç³»ç»Ÿä¸ºå¼€å‘è€…æä¾›äº†æ ‡å‡†åŒ–ã€å¯é‡ç°çš„æ„å»ºç¯å¢ƒã€‚å»ºè®®ï¼š

- **ç”Ÿäº§ä½¿ç”¨**: å®˜æ–¹Dockeræ„å»º
- **å¿«é€Ÿæµ‹è¯•**: ç®€åŒ–Dockeræ„å»º  
- **ç½‘ç»œå—é™**: æœ¬åœ°æ„å»º
- **å³æ—¶ä½¿ç”¨**: é¢„ç¼–è¯‘åŒ…ä¸‹è½½

é€‰æ‹©åˆé€‚çš„æ„å»ºæ–¹æ¡ˆå¯ä»¥å¤§å¹…æå‡å¼€å‘æ•ˆç‡ï¼Œé¿å…ç¯å¢ƒé…ç½®é—®é¢˜ã€‚